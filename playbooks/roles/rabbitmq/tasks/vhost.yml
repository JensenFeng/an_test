---
- name: ensure rabbitmq is running
  service:
    name: rabbitmq-server
    state: started

- name: add rebbitmq user and set privileges
  rabbitmq_user:
    user: {{item.user}
    password: {{item.password}}
    
  with_items: rabbitmq_users_definitions

- name: remove guest user (hostname)
  rabbitmq_user:
    user: guest
    vhost: /
    node: "rabbit@{{ ansible_hostname }}"
    state: absent
  register: rm_guest_hostname
  ignore_errors: true

- name: remove guest user (default)
  rabbitmq_user:
    user: guest
    vhost: /
    state: absent
  when: rm_guest_hostname|failed
